<!DOCTYPE html>
<html>

<head>
    <title></title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.10/lodash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

    <style>
        #map {
            height: 100%;
            width: 100%;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #container {
            display: flex;
            flex: 1;
            position: relative;
            flex-direction: column;
            height: 100%;
        }

        #top-menu {
            position: absolute;
            z-index: 10;
            width: 100%;
        }

        #language-container {
            position: absolute;
            z-index: 11;
            bottom: 10px;
            left: 10px;
        }

        .menu-container {
            border-radius: 10px;
            padding: 10px;
            background-color: rgba(128, 128, 128, 0.7);
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: flex-end;
            margin: 10px;
            box-sizing: border-box;
        }

        #grid {
            display: flex;
            flex-direction: row;
            gap: 10px;
            height: fit-content;
        }

        #google-poi {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        #keywords {
            display: flex;
            flex: 1;
            flex-direction: column;
            align-items: center;
        }

        /* Add this rule to ensure consistent padding */
        input,
        select {
            padding: 8px 8px;
            border-radius: 3px;
            border: 1px solid #ccc;
        }

        .select2-selection {
            padding: 4px;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: unset !important;
        }

        #save-button {
            position: absolute;
            z-index: 110;
            bottom: 30px;
            /* center page */
            left: 50%;
            transform: translateX(-50%);

            padding: 10px;
            border-radius: 10px;
            background-color: white;
            cursor: pointer;
            border: 1px solid black;
            font-size: 20px;
            user-select: none;
        }

        #save-button:hover {
            background-color: #f1f1f1;
        }

        #save-button:active {
            background-color: #e9e9e9;
        }
    </style>
</head>

<body>

    <div id="container">
        <div id="language-container">
            <select class="js-example-basic-single" name="state">
                <option value="">Select language</option>
                <option value="en" data-image="https://flagcdn.com/w20/us.png">English</option>
                <option value="zh" data-image="https://flagcdn.com/w20/cn.png">中文 (Chinese)</option>
                <option value="es" data-image="https://flagcdn.com/w20/es.png">Español (Spanish)</option>
                <option value="hi" data-image="https://flagcdn.com/w20/in.png">हिन्दी (Hindi)</option>
                <option value="ar" data-image="https://flagcdn.com/w20/sa.png">العربية (Arabic)</option>
                <option value="fr" data-image="https://flagcdn.com/w20/fr.png">Français (French)</option>
                <option value="ru" data-image="https://flagcdn.com/w20/ru.png">Русский (Russian)</option>
                <option value="pt" data-image="https://flagcdn.com/w20/br.png">Português (Portuguese)</option>
                <option value="bn" data-image="https://flagcdn.com/w20/bd.png">বাংলা (Bengali)</option>
                <option value="de" data-image="https://flagcdn.com/w20/de.png">Deutsch (German)</option>
                <option value="ja" data-image="https://flagcdn.com/w20/jp.png">日本語 (Japanese)</option>
                <option value="pa" data-image="https://flagcdn.com/w20/in.png">ਪੰਜਾਬੀ (Punjabi)</option>
                <option value="vi" data-image="https://flagcdn.com/w20/vn.png">Tiếng Việt (Vietnamese)</option>
                <option value="ko" data-image="https://flagcdn.com/w20/kr.png">한국어 (Korean)</option>
                <option value="mr" data-image="https://flagcdn.com/w20/in.png">मराठी (Marathi)</option>
                <option value="ta" data-image="https://flagcdn.com/w20/in.png">தமிழ் (Tamil)</option>
                <option value="ur" data-image="https://flagcdn.com/w20/pk.png">اردو (Urdu)</option>
                <option value="tr" data-image="https://flagcdn.com/w20/tr.png">Türkçe (Turkish)</option>
                <option value="fa" data-image="https://flagcdn.com/w20/ir.png">فارسی (Persian)</option>
                <option value="it" data-image="https://flagcdn.com/w20/it.png">Italiano (Italian)</option>
            </select>
        </div>
        <div id="top-menu">
            <div class="menu-container">
                <div id="google-poi">
                    <div style="display: flex;gap:20px;">
                        <div>
                            <input type="radio" id="gpoi_e" name="poi" checked value="establishment">
                            <label for="gpoi_e">Google Business Profile</label>
                        </div>
                        <div>
                            <input type="radio" id="gpoi_g" name="poi" value="geocode">
                            <label for="gpoi_g">Location (no specified GBP)</label>
                        </div>
                    </div>
                    <input type="text" id="search">
                </div>
                <div id="keywords">
                    <select id="multiple-select" style="width: 300px;" multiple></select>
                </div>
                <div id="grid"></div>
            </div>
        </div>
        <div id="map"></div>

        <div id="save-button">Save</div>
    </div>

    <script>

        let map;
        let polyline;
        let distanceOverlay;
        let path = [];
        let autocomplete;
        let mapInit = false;

        const language = new URLSearchParams(window.location.search).get('language') || 'en';

        const saveButton = document.getElementById('save-button');
        const gridDiv = document.getElementById('grid');
        const googleSearch = document.getElementById('search');
        const gpoi_e = document.getElementById('gpoi_e');
        const gpoi_g = document.getElementById('gpoi_g');


        // const mapStyle = [{ "featureType": "water", "elementType": "geometry", "stylers": [{ "color": "#e9e9e9" }, { "lightness": 17 }] }, { "featureType": "landscape", "elementType": "geometry", "stylers": [{ "color": "#f5f5f5" }, { "lightness": 20 }] }, { "featureType": "road.highway", "elementType": "geometry.fill", "stylers": [{ "color": "#ffffff" }, { "lightness": 17 }] }, { "featureType": "road.highway", "elementType": "geometry.stroke", "stylers": [{ "color": "#ffffff" }, { "lightness": 29 }, { "weight": 0.2 }] }, { "featureType": "road.arterial", "elementType": "geometry", "stylers": [{ "color": "#ffffff" }, { "lightness": 18 }] }, { "featureType": "road.local", "elementType": "geometry", "stylers": [{ "color": "#ffffff" }, { "lightness": 16 }] }, { "featureType": "poi", "elementType": "geometry", "stylers": [{ "color": "#f5f5f5" }, { "lightness": 21 }] }, { "featureType": "poi.park", "elementType": "geometry", "stylers": [{ "color": "#dedede" }, { "lightness": 21 }] }, { "elementType": "labels.text.stroke", "stylers": [{ "visibility": "on" }, { "color": "#ffffff" }, { "lightness": 16 }] }, { "elementType": "labels.text.fill", "stylers": [{ "saturation": 36 }, { "color": "#333333" }, { "lightness": 40 }] }, { "elementType": "labels.icon", "stylers": [{ "visibility": "off" }] }, { "featureType": "transit", "elementType": "geometry", "stylers": [{ "color": "#f2f2f2" }, { "lightness": 19 }] }, { "featureType": "administrative", "elementType": "geometry.fill", "stylers": [{ "color": "#fefefe" }, { "lightness": 20 }] }, { "featureType": "administrative", "elementType": "geometry.stroke", "stylers": [{ "color": "#fefefe" }, { "lightness": 17 }, { "weight": 1.2 }] }]

        const appData = new Proxy({
            gridCenter: { lat: 32.0330112964211, lng: 34.82596537402672 },
            gridSize: 5,
            gridGap: 0.1,
            gridUnits: 'km',
            allMarkers: [],
            keywords: [],
        }, {
            set(target, property, value) {
                target[property] = value;
                if (property !== 'allMarkers' && property !== 'keywords') {
                    drawGrid(target);
                }
                return true;
            }
        });

        saveButton.addEventListener('click', () => {
            const url = 'https://jsonplaceholder.typicode.com/posts';

            const data = {
                keywords: appData.keywords,
                language,
                markers: appData.allMarkers.filter(m => m.markerType === "active" || m.markerType === "center").map(m => m.getPosition().toJSON()),
            }

            console.log('data', data);

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Success:', data);
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        });

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 32.0330112964211, lng: 34.82596537402672 },
                zoom: 16,
                streetViewControl: false,
                zoomControl: true,
                mapTypeControl: false,
                rotateControl: false,
                fullscreenControl: false,
                // styles: mapStyle
            });

            !mapInit && onMapInitOnce()
            mapInit = true;
        }

        function onMapInitOnce() {

            function initAutocomplete() {
                autocomplete = new google.maps.places.Autocomplete(googleSearch, {
                    types: ['geocode'],
                });
                autocomplete.addListener('place_changed', onPlaceChanged);
            }

            function onPlaceChanged() {
                var place = autocomplete.getPlace();
                if (!place.geometry) {
                    // User entered the name of a Place that was not suggested and
                    // pressed the Enter key, or the Place Details request failed.
                    googleSearch.placeholder = 'Enter a place';
                } else {
                    const { lat, lng } = place.geometry.location.toJSON();
                    appData.gridCenter = { lat, lng };
                    map.setCenter({ lat, lng });
                }
            }

            google.maps.event.addDomListener(window, 'load', initAutocomplete, {
                types: ['establishment']
            });

            gpoi_e.addEventListener('change', () => {
                autocomplete.setTypes(['establishment']);
            });

            gpoi_g.addEventListener('change', () => {
                autocomplete.setTypes(['geocode']);
            });

            const gridDropDown = createDropDown({
                name: 'gridDropDown',
                container: document.getElementById('top-menu'),
                values: [5, 7, 9, 15, 21],
                onChange: (e) => {
                    appData.gridSize = parseInt(e.target.value);
                }
            });

            const gridGapDropDown = createDropDown({
                name: 'gridGapDropDown',
                container: document.getElementById('top-menu'),
                values: [0.1, 0.2, 0.3, 0.4, 0.5, 1, 2, 3, 4, 5],
                onChange: (e) => {
                    appData.gridGap = parseFloat(e.target.value);
                }
            });

            const gridGapUnitDropDown = createDropDown({
                name: 'gridSize',
                container: document.getElementById('top-menu'),
                values: ["km", "mi"],
                onChange: (e) => {
                    appData.gridUnits = e.target.value;
                }
            });

            gridDiv.appendChild(gridDropDown);
            gridDiv.appendChild(gridGapDropDown);
            gridDiv.appendChild(gridGapUnitDropDown);

            appData.gridCenter = { lat: 32.0330112964211, lng: 34.82596537402672 };

            multipleDropDown()
            languageSelector(language);
        }

        function multipleDropDown() {
            $(document).ready(function () {
                $('#multiple-select').select2({
                    tags: true,
                    placeholder: 'Keywords',
                    allowClear: true
                })
                $('#multiple-select').on("change", function (e) {
                    appData.keywords = $(this).val();
                });
            });
        }

        function drawGrid() {

            appData.allMarkers.forEach((marker) => {
                marker.setMap(null);
            });

            const result = calculateMarkerCoordinates({
                centerCoord: appData.gridCenter,
                rows: appData.gridSize,
                cols: appData.gridSize,
                distanceMeters: appData.gridGap,
                gridUnits: appData.gridUnits
            }).forEach((item) => {
                const [lng, lat] = item.coordinates;
                const marker = createInteractiveMarker(map, { lat, lng }, item.markerType);
                appData.allMarkers.push(marker);
            });
        }

        function createInteractiveMarker(map, position, markerType) {

            const marker = new google.maps.Marker({
                position: position,
                map: map,
                icon: createCircleMarkerIcon(markerType),
                markerType: markerType,
                opacity: markerType === "inactive" ? 0.3 : 1,
                draggable: markerType === "center" ? true : false,

            });
            marker.addListener('click', function () {
                if (markerType === "center") {
                    return;
                }
                const currentActiveState = this.get('markerType');
                const newActiveState = currentActiveState === "active" ? "inactive" : "active";
                this.set('markerType', newActiveState);
                this.setIcon(createCircleMarkerIcon(newActiveState));
                this.setOpacity(newActiveState === "inactive" ? 0.3 : 1);
            });

            marker.addListener('dragend', function (event) {
                appData.gridCenter = { lat: event.latLng.lat(), lng: event.latLng.lng() };
            });

            return marker;
        }

        function createCircleMarkerIcon(markerType) {

            switch (markerType) {
                case "active":
                    return "icons/circle-plus-svgrepo-com.png";
                    break;

                case "center":
                    return "icons/move-alt.png";
                    break;

                case "inactive":
                    return "icons/circle-quarters-svgrepo-com.png";
                    break;

                default:
                    return "icons/circle-quarters-svgrepo-com.png";
                    break;
            }

        }

        function calculateMarkerCoordinates({ centerCoord, cols, rows, distanceMeters, gridUnits }) {
            console.log('centerCoord, cols, rows, distanceMeters', centerCoord, cols, rows, distanceMeters);

            appData.allMarkers = [];

            const coordinates = [];
            const totalMarkers = cols * 3;
            const halfTotal = Math.floor(totalMarkers / 2);
            const halfCols = Math.floor(cols / 2);
            const halfRows = Math.floor(rows / 2);

            const unit = gridUnits === 'km' ? 1 : 1.60934;
            const markerDistance = ((2 * distanceMeters) / (cols - 1)) * unit;
            const lineDistance = markerDistance

            const centerPoint = turf.point([centerCoord.lng, centerCoord.lat]);

            for (let line = 0; line < totalMarkers; line++) {
                const lineOffset = (line - halfTotal) * (lineDistance);
                const lineBearing = lineOffset >= 0 ? 0 : 180;
                const lineStart = turf.destination(centerPoint, Math.abs(lineOffset), lineBearing);

                for (let marker = 0; marker < totalMarkers; marker++) {
                    const markerOffset = (marker - halfTotal) * (markerDistance);
                    const markerBearing = markerOffset >= 0 ? 90 : 270;
                    const markerPoint = turf.destination(lineStart, Math.abs(markerOffset), markerBearing);
                    const [lng, lat] = markerPoint.geometry.coordinates;

                    const isActiveVertically = line >= (halfTotal - halfRows) && line < (halfTotal + halfRows + (rows % 2));
                    const isActiveHorizontally = marker >= (halfTotal - halfCols) && marker < (halfTotal + halfCols + (cols % 2));

                    coordinates.push({
                        coordinates: [lng, lat],
                        markerType:
                            line === halfTotal && marker === halfTotal ? "center" :
                                isActiveVertically && isActiveHorizontally ? "active" : "inactive"
                    });
                }
            }

            return coordinates;
        }

        function languageSelector(language) {
            $('.js-example-basic-single').select2({
                minimumResultsForSearch: Infinity, // Disable search
                templateResult: formatState,
                templateSelection: formatState,
            })

            setTimeout(() => {
                $('.js-example-basic-single').val(language).trigger('change');
            }, 500);


            $('.js-example-basic-single').on('select2:select', function (e) {
                let selectedValue = $(this).val();
                console.log('Selected value:', selectedValue);
                changeLanguage(selectedValue);
            });

            // Detect user's language
            let userLang = navigator.language || navigator.userLanguage;
            userLang = userLang.substring(0, 2).toLowerCase();

            console.log('userLang', userLang);

            $('.js-example-basic-single').select2({
                minimumResultsForSearch: Infinity, // Disable search
                templateResult: formatState,
                templateSelection: formatState,
                initialSelection: userLang
            }).val(userLang).trigger('change');
        }

        function formatState(state) {
            if (!state.id) {
                return state.text;
            }
            var $state = $(
                '<span><img src="' + state.element.getAttribute('data-image') + '" class="img-flag" /> ' + state.text + '</span>'
            );
            return $state;
        }

        function formatState(state) {
            if (!state.id) {
                return state.text;
            }
            var $state = $(
                '<span><img src="' + state.element.getAttribute('data-image') + '" class="img-flag" /> ' + state.text + '</span>'
            );
            return $state;
        }

        function createDropDown({ name, container, values, onChange }) {
            const select = document.createElement('select');
            select.name = name;
            select.id = name;
            select.onchange = onChange;

            values.forEach((value) => {
                const option = document.createElement('option');
                option.value = value;
                option.text = value;
                select.appendChild(option);
            });

            return select;
        }

        function changeLanguage(languageCode) {

            // // Remove the old script
            // const oldScript = document.querySelector('script[src^="https://maps.googleapis.com/maps/api/js"]');
            // if (oldScript) {
            //     oldScript.remove();
            // }

            // const script = document.createElement('script');
            // script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyBeVERtl6-MScPy5xT3ysrJsM4zRkcjGaY&callback=initMap&language=${languageCode}`;
            // script.defer = true;
            // script.async = true;

            // // Add the new script
            // document.head.appendChild(script);

            window.location.href = window.location.pathname + '?language=' + languageCode;
        }

        function loadGoogleMapsApi(language) {
            // Construct the URL for the Google Maps API with the specified language
            var script = document.createElement('script');
            script.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyBeVERtl6-MScPy5xT3ysrJsM4zRkcjGaY&libraries=places&callback=initMap&language=" + language;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }

        loadGoogleMapsApi(language);



    </script>
    <!-- <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBeVERtl6-MScPy5xT3ysrJsM4zRkcjGaY&libraries=places&callback=initMap&language="
        + language async defer></script> -->

</body>

</html>